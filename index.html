<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>Lagerstyring ‚Äì Grupper, Logfiltre, Slet & CSV-export</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1117; --panel:#151928; --muted:#22263a; --text:#e6e8f0; --sub:#a9afc6; --brand:#4f7cff; --ok:#27c93f; --warn:#ffbd2e; --danger:#ff5f56; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:1100px; margin:32px auto; padding:16px; }
    .card { background:linear-gradient(180deg,var(--panel),#121527 60%); border:1px solid #1b2034; border-radius:16px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.35); }
    h1 { margin:0 0 12px; font-size:22px; }
    input, select { background:#0e1222; border:1px solid #21263b; color:var(--text); padding:8px 10px; border-radius:10px; outline:none; }
    input::placeholder{ color:#7f86a5; }
    button { border:0; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer; background:var(--brand); color:white; }
    button.ghost{ background:#0f1324; border:1px solid #20253a; color:#cfd6f5; }
    button.ok{ background:var(--ok); color:#0b2010; }
    button.warn{ background:var(--warn); color:#221a00; }
    button.danger{ background:var(--danger); color:#2b0b0a; }
    button:disabled, input:disabled, select:disabled { opacity:.5; cursor:not-allowed; }
    .row { display:grid; gap:8px; margin-bottom:10px; }
    .row.add { grid-template-columns: 1.2fr .8fr .5fr auto; }
    .row.search { grid-template-columns: 1fr auto; }
    .split { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .muted{ color:var(--sub); font-size:13px; }
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tab { background:#0e1222; border:1px solid #21263b; color:#cfd6f5; }
    .tab.active { background:var(--brand); color:#fff; border-color:transparent; }
    table { width:100%; border-collapse:separate; border-spacing:0 8px; }
    th, td { text-align:left; padding:12px; }
    thead th { color:var(--sub); font-weight:600; border-bottom:1px solid #20263a; }
    tbody tr { background:#121528; border:1px solid #1b2034; }
    tbody tr td:first-child { border-top-left-radius:10px; border-bottom-left-radius:10px; }
    tbody tr td:last-child { border-top-right-radius:10px; border-bottom-right-radius:10px; }
    td.qty { text-align:center; font-variant-numeric:tabular-nums; }
    .actions{ display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap; }
    .lockbar { background:#1a2140; border:1px dashed #2a3466; padding:10px; border-radius:10px; margin-bottom:12px; color:#cfd6f5; }
    .logfilters { display:grid; gap:8px; grid-template-columns: .9fr .9fr .8fr .8fr .8fr auto; margin:10px 0 6px; }
    .hint{ color:#9aa3c7; font-size:12px; margin-top:8px; }
    @media (max-width:900px){ .row.add{ grid-template-columns:1fr 1fr; } .row.search{ grid-template-columns:1fr; } .logfilters{ grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="split">
        <h1>üì¶ Lagerstyring</h1>
        <div class="split" style="gap:6px">
          <label class="muted" for="groupSel">Gruppe:&nbsp;</label>
          <select id="groupSel" style="min-width:220px"></select>
          <button id="newGroupBtn" class="ghost">Ny gruppe</button>
          <button id="deleteGroupBtn" class="danger">Slet gruppe</button>
          <label class="muted" for="who" style="margin-left:12px">Jeg er:&nbsp;</label>
          <input id="who" placeholder="Skriv dit navn (kr√¶vet)" style="height:40px; min-width:200px" />
        </div>
      </div>

      <div id="lockbar" class="lockbar" style="display:none">
        Skriv dit navn i <b>‚ÄúJeg er‚Äù</b> for at l√•se appen op.
      </div>

      <div class="tabs">
        <button id="tabInventory" class="tab active">Lager</button>
        <button id="tabLog" class="tab">Log</button>
      </div>

      <!-- Lager -->
      <div id="viewInventory">
        <div class="row add">
          <input id="addName" placeholder="Varenavn" />
          <input id="addSku"  placeholder="SKU (valgfri)" />
          <input id="addQty"  type="number" min="0" placeholder="Antal (fx 0)" />
          <button id="addItemBtn">Opret vare</button>
        </div>

        <div class="row search">
          <input id="search" placeholder="S√∏g p√• varenavn eller SKU‚Ä¶" />
          <span class="muted" style="align-self:center">Tip: Klik p√• antal for at s√¶tte et specifikt tal</span>
        </div>

        <!-- CSV export for lager -->
        <div class="split" style="margin:6px 0 4px">
          <div class="muted">Eksport:</div>
          <div>
            <button id="exportItemsBtn" class="ghost">Download lager (CSV)</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Vare</th>
              <th>SKU</th>
              <th class="qty">Antal</th>
              <th style="text-align:right">Handlinger</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>

        <div class="split" style="margin-top:10px">
          <div class="muted">Gruppe: <b id="groupLabel">‚Äî</b> &middot; Data i Firestore</div>
          <div class="muted">Total: <span id="total">0</span></div>
        </div>
      </div>

      <!-- Log -->
      <div id="viewLog" style="display:none">
        <div class="logfilters">
          <input id="logUser" placeholder="Filter: bruger" />
          <input id="logItem" placeholder="Filter: vare/SKU" />
          <select id="logType">
            <option value="">Type: alle</option>
            <option value="in">+ (ind)</option>
            <option value="out">- (ud)</option>
            <option value="set">sat til</option>
          </select>
          <input id="logFrom" type="date" />
          <input id="logTo" type="date" />
          <button id="logClear" class="ghost">Ryd filtre</button>
        </div>

        <!-- CSV export for log -->
        <div class="split" style="margin:6px 0 4px">
          <div class="muted">Eksport:</div>
          <div>
            <button id="exportLogBtn" class="ghost">Download log (CSV, filtreret)</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Tid</th>
              <th>Bruger</th>
              <th>Vare</th>
              <th>√Ündring</th>
              <th class="qty">Antal efter</th>
            </tr>
          </thead>
          <tbody id="logRows"></tbody>
        </table>
        <div class="hint">Viser de 300 nyeste h√¶ndelser for valgt gruppe. Brug filtrene ovenfor.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, query, orderBy, limit, serverTimestamp, increment, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* >>> INDS√ÜT DINE 3 FIREBASE-V√ÜRDIER HER <<< */
    const firebaseConfig = {
      apiKey: "AIzaSyDsqfn1gsLsuiq1KLRNGBpIlUZFonIYrrA",
      authDomain: "lagerstyring-55156.firebaseapp.com",
      projectId: "lagerstyring-55156",
      storageBucket: "lagerstyring-55156.appspot.com",
      messagingSenderId: "20971395997",
      appId: "1:20971395997:web:070157d739975e715fad74"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // UI refs
    const whoEl = document.getElementById("who");
    const lockbar = document.getElementById("lockbar");
    const tabInv = document.getElementById("tabInventory");
    const tabLog = document.getElementById("tabLog");
    const viewInv = document.getElementById("viewInventory");
    const viewLog = document.getElementById("viewLog");

    const groupSel = document.getElementById("groupSel");
    const newGroupBtn = document.getElementById("newGroupBtn");
    const deleteGroupBtn = document.getElementById("deleteGroupBtn");
    const groupLabel = document.getElementById("groupLabel");

    const addNameEl = document.getElementById("addName");
    const addSkuEl  = document.getElementById("addSku");
    const addQtyEl  = document.getElementById("addQty");
    const addItemBtn= document.getElementById("addItemBtn");

    const rowsEl = document.getElementById("rows");
    const totalEl = document.getElementById("total");
    const searchEl = document.getElementById("search");

    const logUserEl = document.getElementById("logUser");
    const logItemEl = document.getElementById("logItem");
    const logTypeEl = document.getElementById("logType");
    const logFromEl = document.getElementById("logFrom");
    const logToEl   = document.getElementById("logTo");
    const logClearEl= document.getElementById("logClear");
    const logRowsEl = document.getElementById("logRows");

    const exportItemsBtn = document.getElementById("exportItemsBtn");
    const exportLogBtn   = document.getElementById("exportLogBtn");

    // Navn-l√•s
    const WHO_KEY = "lager_who";
    whoEl.value = localStorage.getItem(WHO_KEY) || "";
    function isUnlocked(){ return (whoEl.value||"").trim().length > 0; }
    function applyLockState() {
      const locked = !isUnlocked();
      [addNameEl, addSkuEl, addQtyEl, addItemBtn, searchEl].forEach(el => el.disabled = locked);
      rowsEl.querySelectorAll("button").forEach(b => b.disabled = locked);
      lockbar.style.display = locked ? "" : "none";
    }
    whoEl.addEventListener("input", () => { localStorage.setItem(WHO_KEY, whoEl.value.trim()); applyLockState(); });

    // Tabs
    function setTab(which){
      if (which === "log") {
        tabInv.classList.remove("active"); tabLog.classList.add("active");
        viewInv.style.display="none"; viewLog.style.display="";
      } else {
        tabLog.classList.remove("active"); tabInv.classList.add("active");
        viewLog.style.display="none"; viewInv.style.display="";
      }
      applyLockState();
    }
    tabInv.onclick = () => setTab("inv");
    tabLog.onclick = () => setTab("log");

    // Grupper
    const GROUP_KEY = "lager_current_group";
    let currentGroupId = localStorage.getItem(GROUP_KEY) || null;
    let unsubItems = null, unsubTx = null;
    let items = [], tx = [];

    function groupPath(col){ return `groups/${currentGroupId}/${col}`; }

    async function ensureDefaultGroup() {
      const gCol = collection(db, "groups");
      const snap = await getDocs(limit(query(gCol, orderBy("name")), 1));
      if (snap.empty) {
        const ref = await addDoc(gCol, { name:"Standard" });
        currentGroupId = ref.id;
        localStorage.setItem(GROUP_KEY, currentGroupId);
      }
    }

    function mountGroupsUi() {
      const gCol = collection(db, "groups");
      onSnapshot(query(gCol, orderBy("name")), (snap) => {
        const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        if (!currentGroupId && list.length) {
          currentGroupId = list[0].id;
          localStorage.setItem(GROUP_KEY, currentGroupId);
        }
        groupSel.innerHTML = list.map(g =>
          `<option value="${g.id}" ${g.id===currentGroupId?'selected':''}>${g.name||'(uden navn)'}</option>`
        ).join("");
        const curr = list.find(x=>x.id===currentGroupId);
        groupLabel.textContent = curr ? curr.name : "‚Äî";
      }, (e) => console.error("Kan ikke l√¶se grupper", e));
    }

    groupSel.addEventListener("change", () => {
      currentGroupId = groupSel.value;
      localStorage.setItem(GROUP_KEY, currentGroupId);
      attachGroupListeners();
    });

    newGroupBtn.addEventListener("click", async () => {
      let name = prompt("Navn p√• ny kunde-/lagergruppe:", "");
      if (name === null) return;
      name = name.trim();
      if (!name) { alert("Skriv et gruppenavn."); return; }
      const ref = await addDoc(collection(db, "groups"), { name });
      currentGroupId = ref.id;
      localStorage.setItem(GROUP_KEY, currentGroupId);
      attachGroupListeners();
    });

    // Lager-render
    const byQuery = (q) => (it) =>
      !q || (it.name||"").toLowerCase().includes(q) || (it.sku||"").toLowerCase().includes(q);

    function itemRow(it) {
      return `
        <tr data-id="${it.id}">
          <td>${it.name}</td>
          <td>${it.sku || '<span class="muted">‚Äî</span>'}</td>
          <td class="qty"><button class="ghost" data-action="setQty" title="S√¶t antal">${it.quantity ?? 0}</button></td>
          <td>
            <div class="actions">
              <button class="ok"   data-action="inc1">+1</button>
              <button class="ok"   data-action="inc10">+10</button>
              <button class="warn" data-action="dec1">-1</button>
              <button class="warn" data-action="dec10">-10</button>
              <button class="ghost" data-action="edit">Redig√©r</button>
              <button class="danger" data-action="del">Slet</button>
            </div>
          </td>
        </tr>`;
    }
    function renderTable(){
      const q = (searchEl.value||"").trim().toLowerCase();
      const filtered = items.filter(byQuery(q));
      rowsEl.innerHTML = filtered.map(itemRow).join("");
      totalEl.textContent = String(items.reduce((a,b)=>a+(b.quantity||0),0));
      applyLockState();
    }

    // Log-render + filtre
    function fmtDelta(d){ return (d>0?"+":"") + d; }
    function fmtTime(ts){ try{ return new Date(ts.seconds*1000).toLocaleString(); }catch{return "‚Äî";} }

    function passLogFilters(x) {
      const u = (logUserEl.value||"").trim().toLowerCase();
      const it= (logItemEl.value||"").trim().toLowerCase();
      const tp= logTypeEl.value;
      const from = logFromEl.value ? new Date(logFromEl.value+"T00:00:00").getTime() : null;
      const to   = logToEl.value   ? new Date(logToEl.value+"T23:59:59").getTime() : null;

      if (u && !(x.by||"").toLowerCase().includes(u)) return false;
      const nameSku = ((x.name||"") + " " + (x.sku||"")).toLowerCase();
      if (it && !nameSku.includes(it)) return false;

      if (tp==="in"  && !(typeof x.delta==="number" && x.delta>0)) return false;
      if (tp==="out" && !(typeof x.delta==="number" && x.delta<0)) return false;
      if (tp==="set" && !(x.delta===null || typeof x.qtyAfter==="number")) return false;

      const t = x.ts? x.ts.seconds*1000 : null;
      if (from && (!t || t<from)) return false;
      if (to   && (!t || t>to))   return false;

      return true;
    }

    function renderLog(){
      const rows = tx.filter(passLogFilters).map(x => `
        <tr>
          <td>${x.ts ? fmtTime(x.ts) : "‚Äî"}</td>
          <td>${x.by || "<span class='muted'>ukendt</span>"}</td>
          <td>${x.name || x.itemName || "‚Äî"}</td>
          <td>${typeof x.delta === "number" ? fmtDelta(x.delta) : "sat til"}</td>
          <td class="qty">${x.qtyAfter ?? "‚Äî"}</td>
        </tr>
      `).join("");
      logRowsEl.innerHTML = rows || `<tr><td colspan="5" class="muted">Ingen logposter (med disse filtre).</td></tr>`;
    }

    [logUserEl, logItemEl, logTypeEl, logFromEl, logToEl].forEach(el => {
      el.addEventListener("input", renderLog);
      el.addEventListener("change", renderLog);
    });
    logClearEl.addEventListener("click", () => {
      logUserEl.value = ""; logItemEl.value=""; logTypeEl.value="";
      logFromEl.value=""; logToEl.value="";
      renderLog();
    });

    // Kollektion helpers pr. gruppe
    function itemsColRef(){ return collection(db, groupPath("items")); }
    function txColRef(){ return collection(db, groupPath("tx")); }

    // Log + CRUD
    async function logChange({ itemId, name, sku="", delta=null, qtyAfter=null }){
      await addDoc(txColRef(), {
        itemId, name, sku, delta, qtyAfter,
        by: (whoEl.value||"").trim() || "ukendt",
        ts: serverTimestamp()
      });
    }

    async function addItem({ name, sku="", quantity=0 }) {
      const ref = await addDoc(itemsColRef(), {
        name, sku, quantity: Math.max(0, Number(quantity)||0)
      });
      await logChange({ itemId: ref.id, name, sku, qtyAfter: Number(quantity)||0 });
    }
    async function changeQty(id, delta){
      const it = items.find(x=>x.id===id); if (!it) return;
      await updateDoc(doc(db, groupPath("items") + "/" + id), { quantity: increment(delta) });
      await logChange({ itemId:id, name: it.name, sku: it.sku||"", delta });
    }
    async function setQty(id, value){
      const q = Math.max(0, Number(value)||0);
      const it = items.find(x=>x.id===id); if (!it) return;
      await updateDoc(doc(db, groupPath("items") + "/" + id), { quantity: q });
      await logChange({ itemId:id, name: it.name, sku: it.sku||"", qtyAfter: q });
    }
    async function editItem(id){
      const it = items.find(x=>x.id===id); if (!it) return;
      const name = prompt("Varenavn:", it.name); if (name===null) return;
      const sku  = prompt("SKU (valgfri):", it.sku||""); if (sku===null) return;
      await updateDoc(doc(db, groupPath("items") + "/" + id), { name: name.trim()||it.name, sku: sku.trim() });
    }
    async function deleteItem(id){
      if (!confirm("Slet denne vare?")) return;
      await deleteDoc(doc(db, groupPath("items") + "/" + id));
    }

    // Slet gruppe (t√∏mmer subcollections i batches)
    async function deleteCollection(colRef, batchSize = 200) {
      while (true) {
        const snap = await getDocs(query(colRef, limit(batchSize)));
        if (snap.empty) break;
        const deletions = snap.docs.map(d => deleteDoc(d.ref));
        await Promise.all(deletions);
      }
    }
    async function deleteCurrentGroup() {
      if (!currentGroupId) { alert("Ingen gruppe valgt."); return; }
      const currOpt = groupSel.querySelector(`option[value="${currentGroupId}"]`);
      const currName = currOpt ? currOpt.textContent : "(ukendt)";
      const confirm1 = confirm(`Er du SIKKER p√•, at du vil slette gruppen "${currName}"? Dette kan ikke fortrydes.`);
      if (!confirm1) return;
      try {
        await deleteCollection(collection(db, `groups/${currentGroupId}/items`));
        await deleteCollection(collection(db, `groups/${currentGroupId}/tx`));
        await deleteDoc(doc(db, "groups", currentGroupId));

        const options = Array.from(groupSel.querySelectorAll("option")).map(o => o.value);
        const next = options.find(v => v !== currentGroupId);
        currentGroupId = next || null;
        if (currentGroupId) {
          localStorage.setItem(GROUP_KEY, currentGroupId);
          groupSel.value = currentGroupId;
          attachGroupListeners();
        } else {
          localStorage.removeItem(GROUP_KEY);
          rowsEl.innerHTML = "";
          logRowsEl.innerHTML = `<tr><td colspan="5" class="muted">Ingen logposter.</td></tr>`;
          totalEl.textContent = "0";
          groupLabel.textContent = "‚Äî";
        }
        alert(`Gruppen "${currName}" er slettet.`);
      } catch (e) {
        console.error("Fejl ved sletning af gruppe:", e);
        alert("Kunne ikke slette gruppen. Tjek Firestore Rules/forbindelse (se Console).");
      }
    }

    // CSV helpers
    function toCsv(rows, headers) {
      const sep = ";";
      const head = headers.map(h => h.label).join(sep);
      const lines = rows.map(r =>
        headers.map(h => {
          let v = r[h.key];
          if (v === undefined || v === null) v = "";
          v = String(v).replace(/\r?\n/g, " ").replace(/;/g, ",");
          return v;
        }).join(sep)
      );
      return "\uFEFF" + [head, ...lines].join("\n"); // UTF-8 BOM for √¶√∏√• i Excel
    }
    function downloadText(filename, text) {
      const blob = new Blob([text], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    function tsToIso(ts) {
      try { if (!ts) return ""; return new Date(ts.seconds * 1000).toISOString(); }
      catch { return ""; }
    }

    // CSV eksport: Lager (hele gruppen)
    exportItemsBtn?.addEventListener("click", async () => {
      if (!currentGroupId) { alert("V√¶lg en gruppe f√∏rst."); return; }
      const snap = await getDocs(query(collection(db, groupPath("items")), orderBy("name")));
      const rows = snap.docs.map(d => {
        const x = d.data();
        return {
          id: d.id,
          name: x.name || "",
          sku: x.sku || "",
          quantity: (x.quantity ?? 0),
          groupId: currentGroupId
        };
      });
      const csv = toCsv(rows, [
        { key: "id",       label: "ItemId" },
        { key: "name",     label: "Varenavn" },
        { key: "sku",      label: "SKU" },
        { key: "quantity", label: "Antal" },
        { key: "groupId",  label: "GruppeId" }
      ]);
      const file = `lager_${currentGroupId}_${new Date().toISOString().slice(0,10)}.csv`;
      downloadText(file, csv);
    });

    // CSV eksport: Log (respekterer filtre, 300 seneste)
    exportLogBtn?.addEventListener("click", async () => {
      if (!currentGroupId) { alert("V√¶lg en gruppe f√∏rst."); return; }
      const snap = await getDocs(query(collection(db, groupPath("tx")), orderBy("ts","desc"), limit(300)));
      const all = snap.docs.map(d => d.data());
      const filtered = all.filter(passLogFilters);
      const rows = filtered.map(x => ({
        time: tsToIso(x.ts),
        by: x.by || "",
        name: x.name || x.itemName || "",
        sku: x.sku || "",
        delta: (typeof x.delta === "number" ? x.delta : ""),
        qtyAfter: (x.qtyAfter ?? ""),
        itemId: x.itemId || "",
        groupId: currentGroupId
      }));
      const csv = toCsv(rows, [
        { key: "time",    label: "Tid (ISO)" },
        { key: "by",      label: "Bruger" },
        { key: "name",    label: "Vare" },
        { key: "sku",     label: "SKU" },
        { key: "delta",   label: "√Ündring" },
        { key: "qtyAfter",label: "Antal efter" },
        { key: "itemId",  label: "ItemId" },
        { key: "groupId", label: "GruppeId" }
      ]);
      const file = `log_${currentGroupId}_${new Date().toISOString().slice(0,10)}.csv`;
      downloadText(file, csv);
    });

    // Events
    addItemBtn.addEventListener("click", async () => {
      if (!isUnlocked()) { alert("Skriv dit navn i 'Jeg er' f√∏rst."); return; }
      const name = addNameEl.value.trim();
      const sku  = addSkuEl.value.trim();
      const qty  = addQtyEl.value;
      if (!name) { alert("Skriv et varenavn."); return; }
      await addItem({ name, sku, quantity: qty });
      addNameEl.value = ""; addSkuEl.value = ""; addQtyEl.value = "";
    });
    deleteGroupBtn.addEventListener("click", deleteCurrentGroup);

    ["keyup","change"].forEach(evt => searchEl.addEventListener(evt, renderTable));
    rowsEl.addEventListener("click", (e) => {
      const btn = e.target.closest("button"); if (!btn) return;
      if (!isUnlocked()) { alert("Skriv dit navn i 'Jeg er' f√∏rst."); return; }
      const tr = btn.closest("tr"); const id = tr.dataset.id; const a = btn.dataset.action;
      if (a==="inc1")   changeQty(id, +1);
      if (a==="inc10")  changeQty(id, +10);
      if (a==="dec1")   changeQty(id, -1);
      if (a==="dec10")  changeQty(id, -10);
      if (a==="setQty") { const val = prompt("Angiv antal:", ""); if (val!==null) setQty(id, val); }
      if (a==="edit")   editItem(id);
      if (a==="del")    deleteItem(id);
    });

    // Lyttere for valgt gruppe
    function attachGroupListeners(){
      if (!currentGroupId) return;
      if (typeof unsubItems === "function") unsubItems();
      if (typeof unsubTx === "function") unsubTx();

      const currOpt = groupSel.querySelector(`option[value="${currentGroupId}"]`);
      groupLabel.textContent = currOpt ? currOpt.textContent : "‚Äî";

      unsubItems = onSnapshot(
        query(collection(db, groupPath("items")), orderBy("name")),
        (snap) => { items = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderTable(); }
      );
      unsubTx = onSnapshot(
        query(collection(db, groupPath("tx")), orderBy("ts","desc"), limit(300)),
        (snap) => { tx = snap.docs.map(d => d.data()); renderLog(); }
      );
    }

    // Init
    (async function init(){
      applyLockState();
      try { await ensureDefaultGroup(); } catch (e) { console.error("Kunne ikke sikre Standard-gruppe", e); }
      mountGroupsUi();
      setTimeout(() => { if (currentGroupId) attachGroupListeners(); }, 300);
    })();
  </script>
</body>
</html>
